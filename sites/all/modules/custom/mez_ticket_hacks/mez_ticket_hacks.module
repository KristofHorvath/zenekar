<?php

/**
 * @file
 * Ticket related stuff
 *
 */

/**
 * Implements hook_permission().
 */
function mez_ticket_hacks_permission() {
  return array(
    'administer mez ticket selling' => array(
      'title' => t('Administer ticket selling'),
    ),
  );
}

/**
 * Implements hook_field_formatter_info().
 */
function mez_ticket_hacks_field_formatter_info() {
  return array(
    'mez_concert_hall' => array(
      'label' => t('MEZ concert hall'),
      'field types' => array('entityreference'),
    ),
  );
}

/**
 * Implements hook_field_formatter_view().
 */
function mez_ticket_hacks_field_formatter_view($entity_type, $entity, $field, $instance, $langcode, $items, $display) {
  $element = array();
  $settings = $display['settings'];
  switch ($display['type']) {
    case 'mez_concert_hall' :
      $path = drupal_get_path('theme', 'mez_theme') . '/css/tickets.css';
      drupal_add_css($path);
      drupal_add_js('misc/ajax.js');
      $ticket_selling = field_get_items('node', $entity, 'field_ticket_selling');
      global $user;
      switch ($ticket_selling[0]['value']) {
        case 'off' :
          return array();
          break;

        case 'admin' :
        case 'on' :
          if (user_access('administer mez ticket selling') || ($ticket_selling[0]['value'] == 'on')) {
            $vars = array(
              'concert_nid' => $entity->nid,
              'concert_hall_nid' => $items[0]['target_id'],
            );
            $markup = theme('mez_concert_hall', $vars);
            $element[0] = array('#markup' => $markup);
          }

          break;
      }
      break;
  }
  return $element;
}

/**
 * Implements hook_theme().
 */
function mez_ticket_hacks_theme() {
  return array(
    'mez_concert_hall' => array(
      'variables' => array(
        'concert_nid' => NULL,
        'concert_hall_nid' => NULL,
       ),
      'template' => 'mez_concert_hall',
      'path' => drupal_get_path('theme', 'mez_theme') . '/templates',
    ),
  );
}
/**
 * Preprocess function for mez_concert_hall.
 */
function mez_ticket_hacks_preprocess_mez_concert_hall(&$vars) {
  // Seats
  $query = new EntityFieldQuery();
  $result = $query->entityCondition('entity_type', 'node')
    ->entityCondition('bundle', 'seat')
    ->propertyCondition('status', 1)
    ->fieldCondition('field_concert_hall', 'target_id', $vars['concert_hall_nid'])
    ->execute();
  $seat_nids = array_keys($result['node']);

  // Tickets
  $query = new EntityFieldQuery();
  $result = $query->entityCondition('entity_type', 'commerce_product')
    ->entityCondition('bundle', 'ticket')
    ->propertyCondition('status', 1)
    ->fieldCondition('field_concert', 'target_id', $vars['concert_nid'])
    ->fieldCondition('field_seat', 'target_id', $seat_nids)
    ->execute();

  $ticket_pids = array_keys($result['commerce_product']);

  $tickets = commerce_product_load_multiple($ticket_pids);
  $vars['seats'] = array();
  foreach ($tickets as $ticket) {
    $ticket_w = entity_metadata_wrapper('commerce_product', $ticket);
    $xcoord = $ticket_w->field_seat->field_x_coordinate->value();
    $ycoord = $ticket_w->field_seat->field_y_coordinate->value();
    $status = $ticket_w->field_ticket_status->value();
    if (!empty($xcoord) && !empty($ycoord)) {
      $text = '<span class="inner" title="' . $ticket_w->field_seat->title_field->value() . '"></span>';
      $vars['seats'][$ticket->product_id] = array(
        'xcoord' => $xcoord,
        'ycoord' => $ycoord,
        'status' => $status,
      );
      switch ($status) {
        case 'free' :
          $vars['seats'][$ticket->product_id]['link'] = l($text, 'mez-ticket-to-basket/nojs/' . $ticket->product_id, array('attributes' => array('class' => array('use-ajax')), 'html' => TRUE));
          break;

        default :
          $vars['seats'][$ticket->product_id]['link'] = $text;
      }
    }
  }

  // Concert hall specific markup.
  $function = 'concert_hall_' . $vars['concert_hall_nid'];
  ctools_include($function, 'mez_ticket_hacks', 'concert_halls');
  $vars['concert_hall_details'] = $function($vars['concert_hall_nid']);
}

/**
 * Implements hook_menu().
 */
function mez_ticket_hacks_menu() {
  $items = array();
  $items['mez-ticket-to-basket/%/%commerce_product'] = array(
    'page callback' => 'mez_ticket_to_basket',
    'page arguments' => array(1, 2),
    'access callback' => 'user_access',
    'access arguments' => 'access checkout',
    'type' => MENU_CALLBACK,
  );
  return $items;
}

/**
 * AJAX callback
 */
function mez_ticket_to_basket($type = 'ajax', $product) {
  if ($type == 'ajax') {
    commerce_cart_product_add_by_id($product->product_id);
    $output = commerce_cart_block_view('cart');
    $commands = array();
    $commands[] = ajax_command_html('#block-commerce-cart-cart', $output);
    $page = array('#type' => 'ajax_commands', '#ajax_commands' => $commands);

    $product->field_ticket_status[LANGUAGE_NONE][0]['value'] = 'reserved';
    commerce_product_save($product);
    ajax_deliver($page);
  }
}
